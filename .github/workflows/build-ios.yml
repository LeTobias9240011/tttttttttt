name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Setup Firebase placeholder
      run: |
        echo "Firebase config files should be added if needed"
        
    - name: Create dummy iOS certificate
      run: |
        # Create a self-signed certificate for ad-hoc signing
        security create-keychain -p actions ios-build.keychain
        security default-keychain -s ios-build.keychain
        security unlock-keychain -p actions ios-build.keychain
        security set-keychain-settings -t 3600 -u ios-build.keychain
        
        # Generate a self-signed certificate
        openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 1 -nodes -subj "/CN=iOS Developer"
        openssl pkcs12 -export -out cert.p12 -inkey key.pem -in cert.pem -passout pass:actions
        
        # Import the certificate
        security import cert.p12 -k ios-build.keychain -P actions -T /usr/bin/codesign -T /usr/bin/security
        security set-key-partition-list -S apple-tool:,apple: -s -k actions ios-build.keychain
    
    - name: Patch Xcode project
      run: |
        # Set manual signing
        ruby -i -pe '$_.gsub!(/CODE_SIGN_STYLE = Automatic;/, "CODE_SIGN_STYLE = Manual;")' ios/Runner.xcodeproj/project.pbxproj
        # Set ad-hoc signing identity
        ruby -i -pe '$_.gsub!(/CODE_SIGN_IDENTITY = .*;/, "CODE_SIGN_IDENTITY = \"-\";")' ios/Runner.xcodeproj/project.pbxproj  
        ruby -i -pe '$_.gsub!(/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = .*;/, "\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"-\";")' ios/Runner.xcodeproj/project.pbxproj
        # Remove provisioning profile requirement
        ruby -i -pe '$_.gsub!(/PROVISIONING_PROFILE_SPECIFIER = .*;/, "PROVISIONING_PROFILE_SPECIFIER = \"\";")' ios/Runner.xcodeproj/project.pbxproj
        # Set empty development team
        ruby -i -pe '$_.gsub!(/DEVELOPMENT_TEAM = .*;/, "DEVELOPMENT_TEAM = \"\";")' ios/Runner.xcodeproj/project.pbxproj
    
    - name: Pod install
      run: |
        cd ios
        pod install
    
    - name: Build iOS App
      run: |
        cd ios
        xcodebuild clean build \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          AD_HOC_CODE_SIGNING_ALLOWED=YES \
          | tee build.log
    
    - name: Find and Create IPA
      if: success()
      run: |
        # Find the built app
        find ios/build -name "Runner.app" -type d
        
        # Create IPA from the built app
        APP_PATH=$(find ios/build -name "Runner.app" -type d | head -n 1)
        if [ -z "$APP_PATH" ]; then
          echo "Error: Runner.app not found!"
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        
        # Create IPA
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -r FairPoint-adhoc.ipa Payload/
        rm -rf Payload
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: FairPoint-iOS-AdHoc
        path: FairPoint-adhoc.ipa
        retention-days: 30
        
    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-log
        path: ios/build.log
        retention-days: 7
        
    - name: Build Summary
      if: always()
      run: |
        echo "‚ö†Ô∏è  Note: This IPA uses ad-hoc signing (for development/testing)"
        echo "üì± Installation options:"
        echo "   1. Use iOS App Signer to re-sign with your certificate"
        echo "   2. Use Diawi.com for OTA installation"
        echo "   3. Use AltStore for sideloading"
        echo "   4. For App Store: Use Codemagic with proper Apple Developer certificates"
        echo "üìñ See IOS_BUILD_GUIDE.md for detailed instructions"

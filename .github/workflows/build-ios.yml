name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Setup Firebase placeholder
      run: |
        # Create a dummy firebase_options.dart for CI builds
        cat > lib/firebase_options.dart << EOF
        import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
        import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
        
        class DefaultFirebaseOptions {
          static FirebaseOptions get currentPlatform {
            if (kIsWeb) return web;
            switch (defaultTargetPlatform) {
              case TargetPlatform.android: return android;
              case TargetPlatform.iOS: return ios;
              default: throw UnsupportedError('Platform not supported');
            }
          }
          static const FirebaseOptions web = FirebaseOptions(
            apiKey: 'AIzaSyDummy-WebKey', appId: '1:123456789:web:abcdef',
            messagingSenderId: '123456789', projectId: 'fairpoint-demo',
            authDomain: 'fairpoint-demo.firebaseapp.com', storageBucket: 'fairpoint-demo.appspot.com',
          );
          static const FirebaseOptions android = FirebaseOptions(
            apiKey: 'AIzaSyDummy-Android', appId: '1:123456789:android:abcdef',
            messagingSenderId: '123456789', projectId: 'fairpoint-demo', storageBucket: 'fairpoint-demo.appspot.com',
          );
          static const FirebaseOptions ios = FirebaseOptions(
            apiKey: 'AIzaSyDummy-iOS', appId: '1:123456789:ios:abcdef',
            messagingSenderId: '123456789', projectId: 'fairpoint-demo', storageBucket: 'fairpoint-demo.appspot.com',
            iosBundleId: 'com.fairpoint.fairpoint',
          );
        }
        EOF
        echo "Created dummy firebase_options.dart for CI build"
        
    - name: Create dummy iOS certificate
      run: |
        # Create a self-signed certificate for ad-hoc signing
        security create-keychain -p actions ios-build.keychain
        security default-keychain -s ios-build.keychain
        security unlock-keychain -p actions ios-build.keychain
        security set-keychain-settings -t 3600 -u ios-build.keychain
        
        # Generate a self-signed certificate
        openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 1 -nodes -subj "/CN=iOS Developer"
        openssl pkcs12 -export -out cert.p12 -inkey key.pem -in cert.pem -passout pass:actions
        
        # Import the certificate
        security import cert.p12 -k ios-build.keychain -P actions -T /usr/bin/codesign -T /usr/bin/security
        security set-key-partition-list -S apple-tool:,apple: -s -k actions ios-build.keychain
    
    - name: Patch Xcode project
      run: |
        # Set manual signing
        ruby -i -pe '$_.gsub!(/CODE_SIGN_STYLE = Automatic;/, "CODE_SIGN_STYLE = Manual;")' ios/Runner.xcodeproj/project.pbxproj
        # Set ad-hoc signing identity
        ruby -i -pe '$_.gsub!(/CODE_SIGN_IDENTITY = .*;/, "CODE_SIGN_IDENTITY = \"-\";")' ios/Runner.xcodeproj/project.pbxproj  
        ruby -i -pe '$_.gsub!(/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = .*;/, "\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"-\";")' ios/Runner.xcodeproj/project.pbxproj
        # Remove provisioning profile requirement
        ruby -i -pe '$_.gsub!(/PROVISIONING_PROFILE_SPECIFIER = .*;/, "PROVISIONING_PROFILE_SPECIFIER = \"\";")' ios/Runner.xcodeproj/project.pbxproj
        # Set empty development team
        ruby -i -pe '$_.gsub!(/DEVELOPMENT_TEAM = .*;/, "DEVELOPMENT_TEAM = \"\";")' ios/Runner.xcodeproj/project.pbxproj
    
    - name: Pod install
      run: |
        cd ios
        pod install
    
    - name: Build iOS App with Flutter
      run: |
        # Build iOS app using Flutter
        flutter build ios \
          --release \
          --no-codesign \
          --no-tree-shake-icons \
          | tee ios/build.log
        
        echo "Build completed. Checking output..."
        ls -la build/ios/Release-iphoneos/ || echo "Release-iphoneos directory not found"
        ls -la build/ios/iphoneos/ || echo "iphoneos directory not found"
    
    - name: Create IPA from Flutter build
      run: |
        # Check if Runner.app exists (try both possible locations)
        if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
          APP_PATH="build/ios/Release-iphoneos/Runner.app"
        elif [ -d "build/ios/iphoneos/Runner.app" ]; then
          APP_PATH="build/ios/iphoneos/Runner.app"
        else
          echo "ERROR: Runner.app not found!"
          echo "Searching for .app bundles..."
          find build -name "*.app" -type d 2>/dev/null || echo "No .app bundles found"
          echo "Directory structure:"
          ls -R build/ios/ 2>/dev/null || echo "build/ios/ not found"
          exit 1
        fi
        
        echo "Found Runner.app at: $APP_PATH"
        
        # Create a dummy provisioning profile with ExpirationDate
        EXPIRATION_DATE=$(date -u -v+1y +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -d "+1 year" +"%Y-%m-%dT%H:%M:%SZ")
        cat > embedded.mobileprovision << PROVEOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>AppIDName</key>
            <string>FairPoint</string>
            <key>ApplicationIdentifierPrefix</key>
            <array><string>DUMMYTEAM</string></array>
            <key>CreationDate</key>
            <date>2024-01-01T00:00:00Z</date>
            <key>ExpirationDate</key>
            <date>${EXPIRATION_DATE}</date>
            <key>Platform</key>
            <array><string>iOS</string></array>
            <key>DeveloperCertificates</key>
            <array><data>DummyCertificateData</data></array>
            <key>Entitlements</key>
            <dict>
                <key>application-identifier</key>
                <string>DUMMYTEAM.com.fairpoint.fairpoint</string>
                <key>get-task-allow</key>
                <true/>
            </dict>
            <key>Name</key>
            <string>FairPoint AdHoc Profile</string>
            <key>TeamIdentifier</key>
            <array><string>DUMMYTEAM</string></array>
            <key>TeamName</key>
            <string>FairPoint Team</string>
            <key>TimeToLive</key>
            <integer>365</integer>
            <key>UUID</key>
            <string>DUMMY-UUID-1234-5678-ABCD</string>
            <key>Version</key>
            <integer>1</integer>
        </dict>
        </plist>
        PROVEOF
        
        echo "Created provisioning profile with expiration: ${EXPIRATION_DATE}"
        
        # Create IPA manually
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Embed the provisioning profile
        cp embedded.mobileprovision Payload/Runner.app/embedded.mobileprovision
        
        # Verify Info.plist exists
        if [ ! -f "Payload/Runner.app/Info.plist" ]; then
          echo "ERROR: Info.plist not found in Runner.app!"
          ls -la Payload/Runner.app/
          exit 1
        fi
        
        echo "Embedded provisioning profile added"
        
        echo "Creating IPA..."
        zip -r FairPoint-adhoc.ipa Payload/
        
        # Verify IPA size
        IPA_SIZE=$(stat -f%z FairPoint-adhoc.ipa 2>/dev/null || stat -c%s FairPoint-adhoc.ipa)
        echo "IPA size: $IPA_SIZE bytes"
        
        if [ "$IPA_SIZE" -lt 10000 ]; then
          echo "ERROR: IPA is too small ($IPA_SIZE bytes)!"
          exit 1
        fi
        
        echo "IPA created successfully!"
        rm -rf Payload
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: FairPoint-iOS-AdHoc
        path: FairPoint-adhoc.ipa
        retention-days: 30
        
    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-log
        path: ios/build.log
        retention-days: 7
        
    - name: Build Summary
      if: always()
      run: |
        echo "=========================================="
        echo "iOS Build Completed"
        echo "=========================================="
        echo ""
        echo "‚ö†Ô∏è  IMPORTANT: This IPA is NOT properly signed!"
        echo ""
        echo "This build uses dummy certificates and provisioning profiles."
        echo "It CANNOT be installed directly on devices."
        echo ""
        echo "üìã To install on a real device, you MUST re-sign it:"
        echo ""
        echo "Option 1: iOS App Signer (Mac)"
        echo "  - Download iOS App Signer from GitHub"
        echo "  - Import your Apple Developer certificate"
        echo "  - Select your provisioning profile"
        echo "  - Re-sign the downloaded IPA"
        echo ""
        echo "Option 2: Xcode Re-sign (Mac)"
        echo "  - Extract IPA: unzip FairPoint-adhoc.ipa"
        echo "  - Re-sign: codesign -f -s 'Your Certificate' Payload/Runner.app"
        echo "  - Re-package: zip -r FairPoint-signed.ipa Payload/"
        echo ""
        echo "Option 3: Use Codemagic or similar CI/CD with real certificates"
        echo "  - Configure Apple Developer account"
        echo "  - Upload certificates and provisioning profiles"
        echo "  - Build with proper signing"
        echo ""
        echo "üìñ See IOS_BUILD_GUIDE.md for detailed instructions"
        echo "=========================================="

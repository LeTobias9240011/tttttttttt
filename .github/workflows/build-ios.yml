name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Setup Firebase placeholder
      run: |
        # Create a dummy firebase_options.dart for CI builds
        cat > lib/firebase_options.dart << 'EOF'
// File generated for CI/CD builds
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for windows - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyDummy-WebKey-ForCIBuilds-NotReal',
    appId: '1:123456789:web:abcdef',
    messagingSenderId: '123456789',
    projectId: 'fairpoint-demo',
    authDomain: 'fairpoint-demo.firebaseapp.com',
    storageBucket: 'fairpoint-demo.appspot.com',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyDummy-AndroidKey-ForCIBuilds-NotReal',
    appId: '1:123456789:android:abcdef',
    messagingSenderId: '123456789',
    projectId: 'fairpoint-demo',
    storageBucket: 'fairpoint-demo.appspot.com',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyDummy-iOSKey-ForCIBuilds-NotReal',
    appId: '1:123456789:ios:abcdef',
    messagingSenderId: '123456789',
    projectId: 'fairpoint-demo',
    storageBucket: 'fairpoint-demo.appspot.com',
    iosBundleId: 'com.fairpoint.fairpoint',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyDummy-macOSKey-ForCIBuilds-NotReal',
    appId: '1:123456789:macos:abcdef',
    messagingSenderId: '123456789',
    projectId: 'fairpoint-demo',
    storageBucket: 'fairpoint-demo.appspot.com',
    iosBundleId: 'com.fairpoint.fairpoint',
  );
}
EOF
        echo "‚úÖ Created dummy firebase_options.dart for CI build"
        
    - name: Create dummy iOS certificate
      run: |
        # Create a self-signed certificate for ad-hoc signing
        security create-keychain -p actions ios-build.keychain
        security default-keychain -s ios-build.keychain
        security unlock-keychain -p actions ios-build.keychain
        security set-keychain-settings -t 3600 -u ios-build.keychain
        
        # Generate a self-signed certificate
        openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 1 -nodes -subj "/CN=iOS Developer"
        openssl pkcs12 -export -out cert.p12 -inkey key.pem -in cert.pem -passout pass:actions
        
        # Import the certificate
        security import cert.p12 -k ios-build.keychain -P actions -T /usr/bin/codesign -T /usr/bin/security
        security set-key-partition-list -S apple-tool:,apple: -s -k actions ios-build.keychain
    
    - name: Patch Xcode project
      run: |
        # Set manual signing
        ruby -i -pe '$_.gsub!(/CODE_SIGN_STYLE = Automatic;/, "CODE_SIGN_STYLE = Manual;")' ios/Runner.xcodeproj/project.pbxproj
        # Set ad-hoc signing identity
        ruby -i -pe '$_.gsub!(/CODE_SIGN_IDENTITY = .*;/, "CODE_SIGN_IDENTITY = \"-\";")' ios/Runner.xcodeproj/project.pbxproj  
        ruby -i -pe '$_.gsub!(/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = .*;/, "\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"-\";")' ios/Runner.xcodeproj/project.pbxproj
        # Remove provisioning profile requirement
        ruby -i -pe '$_.gsub!(/PROVISIONING_PROFILE_SPECIFIER = .*;/, "PROVISIONING_PROFILE_SPECIFIER = \"\";")' ios/Runner.xcodeproj/project.pbxproj
        # Set empty development team
        ruby -i -pe '$_.gsub!(/DEVELOPMENT_TEAM = .*;/, "DEVELOPMENT_TEAM = \"\";")' ios/Runner.xcodeproj/project.pbxproj
    
    - name: Pod install
      run: |
        cd ios
        pod install
    
    - name: Build iOS App with Flutter
      run: |
        # Build iOS app using Flutter
        flutter build ios \
          --release \
          --no-codesign \
          --no-tree-shake-icons \
          | tee ios/build.log
        
        echo "Build completed. Checking output..."
        ls -la build/ios/Release-iphoneos/ || echo "Release-iphoneos directory not found"
        ls -la build/ios/iphoneos/ || echo "iphoneos directory not found"
    
    - name: Create IPA from Flutter build
      run: |
        # Check if Runner.app exists (try both possible locations)
        if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
          APP_PATH="build/ios/Release-iphoneos/Runner.app"
        elif [ -d "build/ios/iphoneos/Runner.app" ]; then
          APP_PATH="build/ios/iphoneos/Runner.app"
        else
          echo "ERROR: Runner.app not found!"
          echo "Searching for .app bundles..."
          find build -name "*.app" -type d 2>/dev/null || echo "No .app bundles found"
          echo "Directory structure:"
          ls -R build/ios/ 2>/dev/null || echo "build/ios/ not found"
          exit 1
        fi
        
        echo "Found Runner.app at: $APP_PATH"
        
        # Create IPA manually
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Verify Info.plist exists
        if [ ! -f "Payload/Runner.app/Info.plist" ]; then
          echo "ERROR: Info.plist not found in Runner.app!"
          ls -la Payload/Runner.app/
          exit 1
        fi
        
        echo "Creating IPA..."
        zip -r FairPoint-adhoc.ipa Payload/
        
        # Verify IPA size
        IPA_SIZE=$(stat -f%z FairPoint-adhoc.ipa 2>/dev/null || stat -c%s FairPoint-adhoc.ipa)
        echo "IPA size: $IPA_SIZE bytes"
        
        if [ "$IPA_SIZE" -lt 10000 ]; then
          echo "ERROR: IPA is too small ($IPA_SIZE bytes)!"
          exit 1
        fi
        
        echo "IPA created successfully!"
        rm -rf Payload
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: FairPoint-iOS-AdHoc
        path: FairPoint-adhoc.ipa
        retention-days: 30
        
    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-log
        path: ios/build.log
        retention-days: 7
        
    - name: Build Summary
      if: always()
      run: |
        echo "‚ö†Ô∏è  Note: This IPA uses ad-hoc signing (for development/testing)"
        echo "üì± Installation options:"
        echo "   1. Use iOS App Signer to re-sign with your certificate"
        echo "   2. Use Diawi.com for OTA installation"
        echo "   3. Use AltStore for sideloading"
        echo "   4. For App Store: Use Codemagic with proper Apple Developer certificates"
        echo "üìñ See IOS_BUILD_GUIDE.md for detailed instructions"
